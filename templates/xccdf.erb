#!/bin/bash

RUN_TIME=$(date +%Y%m%d%H%M)

oscap xccdf eval <% if @remediate %>--remediate<% end %> --profile <%= @profile %> \
     --results <%= scope.lookupvar('openscap::scanner::basedir') %>/results/<%= @profile %>.${RUN_TIME}.html \
     --report <%= scope.lookupvar('openscap::scanner::basedir') %>/reports/<%= @profile %>.${RUN_TIME}.html \
     --tailoring-file <%= scope.lookupvar('openscap::scanner::basedir') %>/profiles/<%= @profile %>.xml \
     --cpe <%= scope.lookupvar('openscap::params::xccdf_cpe') %> \
     <%= scope.lookupvar('openscap::params::xccdf') %> > /dev/null 2>&1

<% if @generate_remediation_script -%>

# get testname
TESTNAME=$(grep -Eo '<TestResult id="[^"]*"' <%= scope.lookupvar('openscap::scanner::basedir') %>/results/<%= @profile %>.${RUN_TIME}.html | cut -f 2 -d\")

# generate remediation script
oscap xccdf generate fix --output <%= scope.lookupvar('openscap::scanner::basedir') %>/remediation_scripts/<%= @profile %>.remediate-${RUN_TIME}.sh \
                          --profile <%= @profile %> \
                          --tailoring-file <%= scope.lookupvar('openscap::scanner::basedir') %>/profiles/<%= @profile %>.xml \
                          --result-id ${TESTNAME} \
                          <%= scope.lookupvar('openscap::scanner::basedir') %>/results/<%= @profile %>.${RUN_TIME}.html
<% end -%>
